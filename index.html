<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta API</title>
</head>
<body> 

  <h1>Consulta API</h1>

  <form>
    <label for="billId">ID do Título:</label>
    <input type="text" id="billId" name="billId" required>
    <button type="button" onclick="buscarEEnviarParaAPIs()">Buscar</button>
  </form>

  <div id="resultado"></div>

  <script>
    async function buscarEEnviarParaAPIs() {
      try {
        var billId = document.getElementById('billId').value;
        var urlSienge = 'http://localhost:3000/api/bills/' + billId;

        const response = await fetch(urlSienge);

        if (!response.ok) {
          throw new Error('Erro na chamada da API Sienge: ' + response.status);
        }

        const data = await response.json();
        console.log('Dados da API do Sienge:', data);

        // Adicione aqui a lógica para manipular os dados da API Sienge
        enviarParaMilvus(data);

        // Exibindo o resultado na página (você pode ajustar conforme necessário)
        var resultadoElemento = document.getElementById('resultado');
        resultadoElemento.innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";

      } catch (error) {
        console.error('Erro na chamada da API Sienge:', error);
      }
    }

      // Função para enviar dados para a API do Milvus
      async function enviarParaMilvus(data) {
        try {
          // Verificar se id existe e não é nulo
          const id = data.id !== undefined && data.id !== null ? data.id.toString() : '';
      
          // Verificar se issueDate existe e não é nulo
          const issueDate = data.issueDate !== undefined && data.issueDate !== null ? data.issueDate.toString() : '';
      
          // Verificar se totalInvoiceAmount existe e não é nulo
          const totalInvoiceAmount = data.totalInvoiceAmount !== undefined && data.totalInvoiceAmount !== null ? data.totalInvoiceAmount.toString() : '';
      
          // Verificar se discount existe e não é nulo
          const discount = data.discount !== undefined && data.discount !== null ? data.discount.toString() : '';
      
          // Verificar se registeredUserId existe e não é nulo
          const registeredUserId = data.registeredUserId !== undefined && data.registeredUserId !== null ? data.registeredUserId.toString() : '';
      
          var dadosMilvus = {
            "cliente_id": "CL4RYB",
            "chamado_assunto": `ID: ${id} - Data de Vencimento: ${issueDate} - R$: ${totalInvoiceAmount} - Desconto: ${discount} - Usuário Registrado: ${registeredUserId}`,
            "chamado_descricao": JSON.stringify(data),
            "chamado_email": "sandro.silva@ebm.com.br",
            "chamado_telefone": "(11) 1234-1234",
            "chamado_contato": "Teste",
            "chamado_tecnico": "sandro.silva@ebm.com.br",
            "chamado_mesa": "SUPORTE N2",
            "Setor do Solicitante": "EA3",
            "chamado_categoria_primaria": "E-MAIL",
            "chamado_categoria_secundaria": "Criar",
            "Unidade de Negócio": "Computador Lento",
            "Empresa": "Computador Lento"
          };
      
          var urlMilvus = 'https://apiintegracao.milvus.com.br/api/chamado/criar';
          var tokenMilvus = 'mzFdxy6kmDsGE4AQ6KYNMiwQWrnKCn6mNdhlL4JaCZLT4njQkybXRpVhRxNKVOfrY54qDvfxMIk39Kd1X7QfjzY6EZoTvVVlOyx9k'; // Substitua pelo seu token real
      
          const responseMilvus = await fetch(urlMilvus, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': tokenMilvus,
            },
            body: JSON.stringify(dadosMilvus),
          });
      
          if (!responseMilvus.ok) {
            throw new Error('Erro na chamada da API Milvus: ' + responseMilvus.status);
          }
      
          const resultMilvus = await responseMilvus.json();
          console.log('Resposta da API Milvus:', resultMilvus);
      
        } catch (error) {
          console.error('Erro na chamada da API Milvus:', error);
        }
      }



  </script>

</body>
</html>
